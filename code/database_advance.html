<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../public/css/coding_page.css">
    <link rel="stylesheet" href="../public/font_awesome/css/all.css">
</head>

<body>
<div class="main-body">
    <span class="header-wrapper">
        <h1>Databse Connection Advance</h1>
        <div class="copy-btn" onclick="copyCode()"><i class="fa-regular fa-copy"></i>Copy</div>
    </span>
    <ul>
        <li>Step 1 : create services Folder </li>
        <li>Step 2 : save file name as java class example : <span class="highlight"> DBConnection.php </span></li>
        <li>Step 3 : give class name as file name  ..<span class="note"> class DBConnection { Inside Code } </span> </li>
        <li>Step 4 : main page to link this : <span class="code"> &lt? php include_once('DBConnection.php'); ?> </span></li>
        <li>Step 5 : Open Xampp Server</li>
    </ul>
    <code>
        <!-- insde span tag used color 
            highlight -> yellow color, 
            note -> red color,
            code -> orange color -->

        <pre id="codeSnippet">
            require_once("Logs.php");
            require_once("UtilityService.php");

            defined('env') or define("env", "LOCAL");

            if (env == "LOCAL") {
                define("HOST", "localhost");
                define("USERNAME", "root");
                define("PASSWORD", "");
                define("DBNAME", "trulloy_management");
            } else if (env == "PROD") {
                define("HOST", "localhost");
                define("USERNAME", "tr_super_user");
                define("PASSWORD", "trulloy@2024");
                define("DBNAME", "trulloy_management");
            }

            class DBConnectionService {

                private $con = null;

                function __construct() {
                    // $this->con = mysqli_connect(DBConnectionService::$host, DBConnectionService::$username, DBConnectionService::$password, DBConnectionService::$dbname);
                    $this->con = mysqli_connect(HOST, USERNAME, PASSWORD, DBNAME);
                    if (mysqli_connect_errno()) {
                        $this->con = null;
                    } else {
                        $this->updateCount(1);
                        $updateSql = "update connection_count set created = (created + 1) where id = 1";
                        mysqli_query($this->con, $updateSql);
                    }
                }
                
                function getConnection() {
                    if (!$this->con) {
                        return null;
                    } else {
                        return $this->con;
                    }
                }

                function __destruct() {
                    if ($this->con != null) {
                        $updateSql = "update connection_count set destroyed = (destroyed + 1) where id = 1";
                        mysqli_query($this->con, $updateSql);
                        $this->updateCount(2);
                        mysqli_close($this->con);
                    }
                }

                function exec($sql) {
                    $updateSql = "update connection_count set query = (query + 1) where id = 1";
                    mysqli_query($this->con, $updateSql);
                    $result = mysqli_query($this->con, $sql);
                    $this->updateCount(3);
                    return $result;
                }

                function updateCount($type) {
                    // $json = file_get_contents('count.db.json');
                    $json = file_get_contents(UtilityService::getBaseDirectory() . '/services/count.db.json');
                    $val = json_decode($json, true);
                    $create = $val["created"];
                    $destroy = $val["destroyed"];
                    $query = $val["query"];
                    if ($type == 1) {
                        $create = $val["created"] + 1;
                    } else if ($type == 2) {
                        $destroy = $val["destroyed"] + 1;
                    } else {
                        $query = $val["query"] + 1;
                    }
                    // $cb = fopen('count.db.json', 'w');
                    Logs::debug("DBConnection Service - " . UtilityService::getBaseDirectory() . '/services/count.db.json');

                    // $cb = fopen(UtilityService::getBaseDirectory() . '/services/count.db.json', 'w');
                    // fwrite($cb, '{"created":'.$create.',"destroyed":'.$destroy.',"query":'.$query.'}');
                    // fclose($cb);
                }
            }
        </pre>  
    </code>
</div>

<script src="../public/js/CopyClipBord.js"></script>
</body>
</html>
